{"version":3,"file":"SearchMsg-463d7702.js","sources":["../../../src/views/test/test-8/_components/SearchMsg.vue"],"sourcesContent":["<!-- 组件-聊天记录搜索-->\r\n<template>\r\n  <div class=\"search-msg f-fs-s-c\">\r\n    <el-input\r\n      class=\"mb-h f-0\"\r\n      v-debounce:input=\"(e:any)=>handleInput(e)\"\r\n      v-model=\"searchVal\"\r\n      placeholder=\"请输入关键词\"\r\n      clearable\r\n      @clear=\"handleClear\"\r\n      :suffix-icon=\"Search\"\r\n      v-focus\r\n    />\r\n    <LoadMore :loading=\"msgsInfo.loading\" class=\"list\" @reachBottom=\"handleReachBottom\" max-height=\"calc(100vh - 200px)\">\r\n      <div @click=\"handleClick(item)\" class=\"item\" v-for=\"(item, ind) in msgsInfo.list\" :key=\"ind\">\r\n        <div class=\"f-fs-c\">\r\n          <b class=\"nickname mr-o\">{{ item.user.nickname }}</b>\r\n          <time class=\"time\">{{ item.createdDate }}</time>\r\n        </div>\r\n        <div class=\"line-1\" v-html=\"getHtml(item)\"></div>\r\n      </div>\r\n    </LoadMore>\r\n  </div>\r\n</template>\r\n<script lang=\"ts\" setup>\r\nimport { ref, reactive, watch, computed, inject, watchEffect } from \"vue\";\r\nimport { Search } from \"@element-plus/icons-vue\";\r\nimport { CommonObj, FinallyNext, StrNum } from \"@/vite-env\";\r\nimport { GetImSearchP2pChatList } from \"@/api-mock\";\r\nimport LoadMore from \"@/components/LoadMore.vue\";\r\nimport cssVars from \"@/assets/styles/_var.module.scss\";\r\nimport { ElMessage } from \"element-plus\";\r\nconst closePopup: any = inject(\"closePopup\");\r\nconst props = withDefaults(\r\n  defineProps<{\r\n    fromUser: CommonObj;\r\n    toUser: CommonObj;\r\n    keyWord?: string;\r\n  }>(),\r\n  {}\r\n);\r\nconst emits = defineEmits([\"select\"]);\r\nconst searchVal = ref(props.keyWord);\r\nconst msgsInfo = reactive<CommonObj>({\r\n  loading: false,\r\n  list: [],\r\n  hasMore: true,\r\n  params: {\r\n    prevCreatedAt: 0,\r\n    pageSize: 15,\r\n  },\r\n});\r\nconst stopWatch = watchEffect(() => {\r\n  getMsgsList(props.keyWord);\r\n});\r\nstopWatch();\r\nfunction getHtml(data: CommonObj, style: string = `color:${cssVars.colorPrimary};`) {\r\n  const { msgContent } = data;\r\n  const val = searchVal.value?.trim();\r\n  return msgContent.Text.replaceAll(val, `<span style='${style}'>${val}</span>`);\r\n}\r\n//处理输入框输入事件\r\nfunction handleInput(e: any) {\r\n  getMsgsList(searchVal.value);\r\n}\r\n//点击清除按钮\r\nfunction handleClear() {\r\n  Object.assign(msgsInfo, { list: [], prevCreatedAt: 0, hasMore: true });\r\n}\r\n//处理触底事件\r\nfunction handleReachBottom() {\r\n  const { list } = msgsInfo;\r\n  msgsInfo.params.prevCreatedAt = list.slice(-1)?.[0]?.createdAt + 1;\r\n  getMsgsList(searchVal.value);\r\n}\r\n//获取查询到的消息列表\r\nfunction getMsgsList(val: string = \"\") {\r\n  val = val?.trim();\r\n  if (!val) {\r\n    handleClear();\r\n    return;\r\n  }\r\n  const { fromUser, toUser } = props;\r\n  const { hasMore, list: oldList, params } = msgsInfo;\r\n  const { prevCreatedAt } = params;\r\n  const isFirstPage = prevCreatedAt === 0;\r\n  if (!isFirstPage && !hasMore) {\r\n    ElMessage.warning(\"底部没有更多了\");\r\n    return;\r\n  }\r\n  msgsInfo.loading = true;\r\n  GetImSearchP2pChatList({\r\n    fromUserId: fromUser.id,\r\n    toUserId: toUser.id,\r\n    // queryDirection: \"next\",\r\n    msgWord: val,\r\n    isListReverse: 0, //数据列表顺序是否反转,1=是(默认),0不\r\n    ...msgsInfo.params,\r\n  })\r\n    .then((res: CommonObj) => {\r\n      const { fromUser, toUser } = props;\r\n      const { list, hasMore, fromUserId } = res;\r\n      const newList = list.map((item: CommonObj, ind: number) => {\r\n        item.user = fromUserId === item.fromUserId ? fromUser : toUser;\r\n        return item;\r\n      });\r\n      Object.assign(msgsInfo, {\r\n        list: isFirstPage ? newList : oldList.concat(newList),\r\n        hasMore,\r\n      });\r\n    })\r\n    .finally(() => {\r\n      msgsInfo.loading = false;\r\n    });\r\n}\r\nfunction handleClick(row: CommonObj) {\r\n  emits(\"select\", row, searchVal.value, () => {\r\n    closePopup();\r\n  });\r\n}\r\n</script>\r\n<style lang=\"scss\" name=\"\" scoped>\r\n.search-msg {\r\n  width: 700px;\r\n}\r\n.list {\r\n  // max-height: calc(100vh - 200px);\r\n  overflow: auto;\r\n  .item {\r\n    cursor: pointer;\r\n    padding: $gap-half;\r\n    &:hover {\r\n      background: $color-bg-lighter;\r\n    }\r\n    &:not(:last-child) {\r\n      border-bottom: $border-main;\r\n    }\r\n    .nickname {\r\n      color: $color-text-main;\r\n      font-size: 13px;\r\n    }\r\n    .time {\r\n      color: $color-text-light;\r\n      font-size: 13px;\r\n    }\r\n  }\r\n}\r\n</style>\r\n"],"names":["closePopup","inject","props","__props","emits","__emit","searchVal","ref","keyWord","msgsInfo","reactive","loading","list","hasMore","params","prevCreatedAt","pageSize","getHtml","data","style","cssVars","colorPrimary","msgContent","val","_a","value","trim","Text","replaceAll","handleClear","Object","assign","handleReachBottom","_b","slice","createdAt","getMsgsList","fromUser","toUser","oldList","isFirstPage","GetImSearchP2pChatList","fromUserId","id","toUserId","msgWord","isListReverse","then","res","newList","map","item","ind","user","concat","finally","ElMessage","warning","watchEffect"],"mappings":"0wDAgCM,MAAAA,EAAkBC,EAAO,cACzBC,EAAQC,EAQRC,EAAQC,EACRC,EAAYC,EAAIL,EAAMM,SACtBC,EAAWC,EAAoB,CACnCC,SAAS,EACTC,KAAM,GACNC,SAAS,EACTC,OAAQ,CACNC,cAAe,EACfC,SAAU,MAOd,SAASC,EAAQC,EAAiBC,EAAgB,SAASC,EAAQC,uBAC3D,MAAAC,WAAEA,GAAeJ,EACjBK,EAAM,OAAAC,EAAUlB,EAAAmB,YAAO,EAAAD,EAAAE,OACtB,OAAAJ,EAAWK,KAAKC,WAAWL,EAAK,gBAAgBJ,MAAUI,WACnE,CAMA,SAASM,IACAC,OAAAC,OAAOtB,EAAU,CAAEG,KAAM,GAAIG,cAAe,EAAGF,SAAS,GACjE,CAEA,SAASmB,YACD,MAAApB,KAAEA,GAASH,EACRA,EAAAK,OAAOC,eAAgB,OAAAkB,EAAA,OAAKT,EAAAZ,EAAAsB,gBAAL,EAAAV,EAAiB,SAAjB,EAAAS,EAAqBE,WAAY,EACjEC,EAAY9B,EAAUmB,MACxB,CAES,SAAAW,EAAYb,EAAc,IAEjC,KADAA,EAAW,MAALA,OAAK,EAAAA,EAAAG,QAGT,gBAEI,MAAAW,SAAEA,EAAUC,OAAAA,GAAWpC,GACvBW,QAAEA,EAASD,KAAM2B,EAAAzB,OAASA,GAAWL,GACrCM,cAAEA,GAAkBD,EACpB0B,EAAgC,IAAlBzB,EACfyB,GAAgB3B,GAIrBJ,EAASE,SAAU,EACI8B,EAAA,CACrBC,WAAYL,EAASM,GACrBC,SAAUN,EAAOK,GAEjBE,QAAStB,EACTuB,cAAe,KACZrC,EAASK,SAEXiC,MAAMC,IACL,MAAQX,SAAAA,EAAUC,OAAAA,GAAWpC,GACvBU,KAAEA,EAAMC,QAAAA,EAAAA,WAAS6B,GAAeM,EAChCC,EAAUrC,EAAKsC,KAAI,CAACC,EAAiBC,KACzCD,EAAKE,KAAOX,IAAeS,EAAKT,WAAaL,EAAWC,EACjDa,KAETrB,OAAOC,OAAOtB,EAAU,CACtBG,KAAM4B,EAAcS,EAAUV,EAAQe,OAAOL,GAC7CpC,QAAAA,GACD,IAEF0C,SAAQ,KACP9C,EAASE,SAAU,CAAA,KAzBrB6C,EAAUC,QAAQ,UA2BtB,QA9DkBC,GAAY,KAC5BtB,EAAYlC,EAAMM,QAAO,+RAUzB4B,EAAY9B,EAAUmB,2LAqDtBrB,EAAM,WAAeE,EAAUmB,OAAO"}