{"version":3,"file":"BaseUpload-a5182420.js","sources":["../../../src/components/upload/BaseUpload.vue"],"sourcesContent":["<template>\r\n  <div class=\"base-upload\">\r\n    <el-upload\r\n      class=\"upload f-c-c\"\r\n      :class=\"{ disabled }\"\r\n      :action=\"action\"\r\n      :show-file-list=\"showFileList\"\r\n      :before-upload=\"beforeUpload\"\r\n      :on-progress=\"handleProgress\"\r\n      :on-success=\"handleSuccess\"\r\n      :on-error=\"handleError\"\r\n      :headers=\"headers\"\r\n    >\r\n      <div class=\"f-c-c-c upload-err-mask\" v-if=\"errSrc\">\r\n        <BaseIcon size=\"26\" name=\"Picture\"></BaseIcon>\r\n        <div>上传失败</div>\r\n      </div>\r\n      <template v-if=\"src || errSrc\">\r\n        <BaseIcon\r\n          @click.stop=\"handleDelete\"\r\n          class=\"icon-del\"\r\n          :class=\"{ disabled }\"\r\n          size=\"24\"\r\n          name=\"CircleCloseFilled\"\r\n          v-if=\"!disabled && !errSrc\"\r\n        />\r\n        <BaseImg class=\"img\" :src=\"src || errSrc\" :fit=\"fit\" :preview=\"disabled\" />\r\n      </template>\r\n      <template v-else>\r\n        <el-progress\r\n          type=\"circle\"\r\n          :width=\"parseInt(size.toString()) * 0.8\"\r\n          :percentage=\"percentage\"\r\n          :stroke-width=\"4\"\r\n          v-if=\"percentage > 0 && percentage < 100\"\r\n        />\r\n        <BaseIcon class=\"icon-add\" :size=\"parseFloat(newSize.toString()) / 4\" name=\"Plus\" v-else></BaseIcon>\r\n      </template>\r\n    </el-upload>\r\n    <div class=\"tips\" v-if=\"showTips\">{{ tips }}</div>\r\n  </div>\r\n</template>\r\n\r\n<script lang=\"ts\" setup>\r\nimport { reactive, ref, computed } from \"vue\";\r\nimport { useFormItem, useFormDisabled } from \"element-plus\";\r\nimport type { UploadProps } from \"element-plus\";\r\nimport { storage, toCssVal, isProd, showMessage } from \"@/components/_utils\";\r\nimport config from \"@/config\";\r\nimport { StrNum, CommonObj, FinallyNext } from \"@/vite-env\";\nimport { defineOptions } from 'vue'; \ndefineOptions({ name: \"BaseUpload\" }); \n\r\nconst props = withDefaults(\r\n  defineProps<{\r\n    modelValue?: string;\r\n    size?: string | number;\r\n    fit?: any; //EpPropMergeType<StringConstructor>\r\n    showFileList?: boolean;\r\n    drag?: boolean;\r\n    accept?: string; //image/png, image/jpeg\r\n    limitSize?: number; //图片大小限制\r\n    headers?: CommonObj;\r\n    action?: string;\r\n    showTips?: boolean;\r\n    handleSuccessResponse?: (res: CommonObj, upFile: CommonObj) => Promise<any>;\r\n  }>(),\r\n  Object.assign(\r\n    {\r\n      size: 100,\r\n      fit: \"cover\",\r\n      showFileList: false,\r\n      showTips: true,\r\n      accept: \"image/png,image/jpg,image/jpeg\",\r\n      limitSize: 1024 * 1024 * 10, //10M\r\n      // headers: () => ({ \"X-Token\": storage.getItem(\"token\") }),\r\n      // action: `${isProd ? \"\" : \"/proxy\"}/api/admin/upload/image`,\r\n      // handleSuccessResponse: (res: CommonObj, upFile: CommonObj) => {\r\n      //   return new Promise((resolve, reject) => {\r\n      //     const { code, message, data } = res;\r\n      //     if (code === 2000) {\r\n      //       resolve(data.fullUrl);\r\n      //     } else {\r\n      //       reject(message);\r\n      //     }\r\n      //   });\r\n      // },\r\n    },\r\n    config?.BaseUpload\r\n  )\r\n);\r\nconst emits = defineEmits([\"update:modelValue\", \"change\"]);\r\nconst percentage = ref(0);\r\nconst { formItem } = useFormItem();\r\nconst disabled = ref(useFormDisabled().value);\r\nconst newSize = toCssVal(props.size);\r\nconst errSrc = ref(\"\"); //上传失败图片的地址(本地生成)\r\nconst src = computed({\r\n  get() {\r\n    return props.modelValue || \"\";\r\n  },\r\n  set(val: string) {\r\n    emits(\"update:modelValue\", val);\r\n    formItem?.validate(\"blur\");\r\n  },\r\n});\r\nconst tips = computed(() => {\r\n  const { accept, limitSize } = props;\r\n  const type = getAcceptTypeStr(accept);\r\n  const size = getLimitSizeStr(limitSize);\r\n  return `仅支持${type}，不超过${size}`;\r\n});\r\n//上传前处理\r\nconst beforeUpload: UploadProps[\"beforeUpload\"] = file => {\r\n  const { limitSize, accept } = props;\r\n  const { type, size } = file;\r\n  const errTips = validType(accept, type) || validSize(limitSize, size);\r\n  if (errTips) {\r\n    showMessage(errTips, \"error\");\r\n    return false;\r\n  }\r\n  return true;\r\n};\r\n//上传中\r\nconst handleProgress: UploadProps[\"onProgress\"] = file => {\r\n  const { loaded, total } = file;\r\n  percentage.value = Math.floor((loaded / total) * 100);\r\n};\r\n//上传成功\r\nconst handleSuccess: UploadProps[\"onSuccess\"] = (res, upFile) => {\r\n  props\r\n    .handleSuccessResponse(res, upFile)\r\n    .then((url: string) => {\r\n      src.value = url;\r\n      emits(\"change\", url);\r\n    })\r\n    .catch((msg: string) => {\r\n      showMessage(msg, \"error\");\r\n    });\r\n};\r\n//上传失败\r\nconst handleError: UploadProps[\"onError\"] = (err, upFile, upFiles) => {\r\n  showMessage(\"文件上传失败\", \"error\");\r\n  errSrc.value = URL.createObjectURL(upFile.raw);\r\n};\r\n\r\n//删除图片\r\nfunction handleDelete() {\r\n  if (disabled.value) return;\r\n  src.value = \"\";\r\n}\r\n\r\n/**\r\n * 获取支持上传的图片后缀类型\r\n */\r\nfunction getAcceptTypeStr(accept: string): string {\r\n  const types = accept.split(\",\").map((it: string) => it.split(\"/\")[1]);\r\n  return types.join(\"，\");\r\n}\r\n\r\n/**\r\n * 获取支持上传的图片大小限制(自带单位)\r\n */\r\nfunction getLimitSizeStr(limitSize: number): string {\r\n  let size = limitSize / 1024;\r\n  let sizeStr = \"\";\r\n  if (size < 1024) {\r\n    sizeStr = `${size.toFixed(1)}kb`;\r\n  } else {\r\n    size = size / 1024;\r\n    sizeStr = `${size.toFixed(1)}Mb`;\r\n  }\r\n  return sizeStr;\r\n}\r\n\r\n/**\r\n * 校验图片类型\r\n * @param accept string  image/png,image/jpeg\r\n * @param fileType string  image/png,image/jpeg\r\n */\r\nfunction validType(accept: string, fileType: string): string {\r\n  let tips = \"\";\r\n  const acceptTypes = accept.split(\",\");\r\n  if (!acceptTypes.includes(fileType)) {\r\n    tips = `仅支持上传${getAcceptTypeStr(accept)}格式的图片`;\r\n  }\r\n  return tips;\r\n}\r\n\r\n/**\r\n * 校验图片类型\r\n * @param accept string  image/png,image/jpeg\r\n * @param type string  image/png,image/jpeg\r\n */\r\nfunction validSize(limitSize: number, fileSize: number) {\r\n  return fileSize > limitSize ? `图片大小不能超过${getLimitSizeStr(limitSize)}` : \"\";\r\n}\r\n</script>\r\n\r\n<style lang=\"scss\" scoped>\r\n$size: v-bind(newSize);\r\n.base-upload {\r\n  .upload {\r\n    position: relative;\r\n    height: $size;\r\n    width: $size;\r\n    border-radius: $radius-main;\r\n    border: 1px dashed $color-border-main;\r\n    background: $color-bg-lighter;\r\n    transition: all $transition-time-main;\r\n\r\n    &:hover {\r\n      .upload-err-mask {\r\n        display: none;\r\n      }\r\n    }\r\n\r\n    &.disabled {\r\n      :deep(.el-upload) {\r\n        cursor: not-allowed;\r\n      }\r\n    }\r\n\r\n    .icon-del {\r\n      position: absolute;\r\n      right: -8px;\r\n      top: -8px;\r\n      z-index: 2;\r\n      opacity: 0.7;\r\n\r\n      &.disabled {\r\n        cursor: not-allowed;\r\n      }\r\n\r\n      &:hover {\r\n        opacity: 1;\r\n      }\r\n    }\r\n\r\n    .img {\r\n      height: $size;\r\n      width: $size;\r\n      border-radius: $radius-main;\r\n      overflow: hidden;\r\n      // .err-box {\r\n      //   height: 100%;\r\n      //   width: 100%;\r\n      //   font-size: 12px;\r\n      //   color: $color-text-light;\r\n      //   line-height: 1.4;\r\n      // }\r\n    }\r\n\r\n    .icon-add {\r\n      color: $color-text-light;\r\n      padding: 36px;\r\n      // background: red;\r\n    }\r\n\r\n    &:hover {\r\n      border: 1px dashed $color-primary;\r\n\r\n      .icon-add {\r\n        color: $color-primary;\r\n      }\r\n    }\r\n\r\n    &.disabled {\r\n      border: 1px dashed $color-border-main;\r\n\r\n      &:hover {\r\n        cursor: not-allowed;\r\n\r\n        .icon-add {\r\n          cursor: not-allowed;\r\n          color: $color-text-light;\r\n        }\r\n      }\r\n    }\r\n\r\n    .upload-err-mask {\r\n      position: absolute;\r\n      left: 0;\r\n      top: 0;\r\n      width: 100%;\r\n      height: 100%;\r\n      z-index: 1;\r\n      color: $color-danger;\r\n      border-radius: $radius-main;\r\n      background: rgba(#000, 0.5);\r\n    }\r\n  }\r\n\r\n  .tips {\r\n    padding: $gap-qtr 0 0;\r\n    line-height: 1.4;\r\n    color: $color-text-light;\r\n    font-size: $font-size-lighter;\r\n  }\r\n}\r\n</style>\r\n"],"names":["props","__props","emits","__emit","percentage","ref","formItem","useFormItem","disabled","useFormDisabled","value","newSize","toCssVal","size","errSrc","src","computed","get","modelValue","set","val","validate","tips","accept","limitSize","getAcceptTypeStr","getLimitSizeStr","beforeUpload","file","type","errTips","fileType","acceptTypes","split","includes","tips2","validType","fileSize","validSize","showMessage","handleProgress","loaded","total","Math","floor","handleSuccess","res","upFile","handleSuccessResponse","then","url","catch","msg","handleError","err","upFiles","URL","createObjectURL","raw","handleDelete","map","it","join","sizeStr","toFixed"],"mappings":"8nEAqDA,MAAMA,EAAQC,EAsCRC,EAAQC,EACRC,EAAaC,EAAI,IACjBC,SAAEA,GAAaC,IACfC,EAAWH,EAAII,IAAkBC,OACjCC,EAAUC,EAASZ,EAAMa,MACzBC,EAAST,EAAI,IACbU,EAAMC,EAAS,CACnBC,IAAM,IACGjB,EAAMkB,YAAc,GAE7B,GAAAC,CAAIC,GACFlB,EAAM,oBAAqBkB,GAC3B,MAAAd,GAAAA,EAAUe,SAAS,OACrB,IAEIC,EAAON,GAAS,KACd,MAAAO,OAAEA,EAAQC,UAAAA,GAAcxB,EAGvB,MAAA,MAFMyB,EAAiBF,SACjBG,EAAgBF,IACD,IAGxBG,EAAoDC,IAClD,MAAAJ,UAAEA,EAAWD,OAAAA,GAAWvB,GACxB6B,KAAEA,EAAMhB,KAAAA,GAASe,EACjBE,EAgEC,SAAUP,EAAgBQ,GACjC,IAAIT,EAAO,GACL,MAAAU,EAAcT,EAAOU,MAAM,KAC5BD,EAAYE,SAASH,KACjBI,EAAA,QAAQV,EAAiBF,WAE3BD,OAAAA,CACT,CAvEkBc,CAAUb,EAAQM,IA8E3B,SAAUL,EAAmBa,GACpC,OAAOA,EAAWb,EAAY,WAAWE,EAAgBF,KAAe,EAC1E,CAhF6Cc,CAAUd,EAAWX,GAChE,OAAIiB,IACFS,EAAYT,EAAS,UACd,EAEF,EAGHU,EAAoDZ,IAClD,MAAAa,OAAEA,EAAQC,MAAAA,GAAUd,EAC1BxB,EAAWM,MAAQiC,KAAKC,MAAOH,EAASC,EAAS,IAAG,EAGhDG,EAA0C,CAACC,EAAKC,KACpD/C,EACGgD,sBAAsBF,EAAKC,GAC3BE,MAAMC,IACLnC,EAAIL,MAAQwC,EACZhD,EAAM,SAAUgD,EAAG,IAEpBC,OAAOC,IACNb,EAAYa,EAAK,QAAO,GACzB,EAGCC,EAAsC,CAACC,EAAKP,EAAQQ,KACxDhB,EAAY,SAAU,SACtBzB,EAAOJ,MAAQ8C,IAAIC,gBAAgBV,EAAOW,IAAG,EAI/C,SAASC,IACHnD,EAASE,QACbK,EAAIL,MAAQ,GACd,CAKA,SAASe,EAAiBF,GAEjB,OADOA,EAAOU,MAAM,KAAK2B,KAAKC,GAAeA,EAAG5B,MAAM,KAAK,KACrD6B,KAAK,IACpB,CAKA,SAASpC,EAAgBF,GACvB,IAAIX,EAAOW,EAAY,KACnBuC,EAAU,GAOP,OANHlD,EAAO,KACTkD,EAAU,GAAGlD,EAAKmD,QAAQ,QAE1BnD,GAAc,KACdkD,EAAU,GAAGlD,EAAKmD,QAAQ,QAErBD,CACT"}