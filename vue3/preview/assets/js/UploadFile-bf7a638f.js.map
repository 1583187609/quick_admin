{"version":3,"file":"UploadFile-bf7a638f.js","sources":["../../../src/components/upload/UploadFile.vue"],"sourcesContent":["<template>\r\n  <div class=\"upload-file f-fs-c\">\r\n    <el-input\r\n      placeholder=\"请点击右侧按钮选择文件\"\r\n      clearable\r\n      v-model=\"file.name\"\r\n      :disabled=\"!file.url\"\r\n      @clear=\"emits('update:modelValue', { name: '', url: '' })\"\r\n    />\r\n    <el-upload\r\n      class=\"upload f-c-c\"\r\n      :class=\"{ disabled }\"\r\n      :action=\"action\"\r\n      :show-file-list=\"showFileList\"\r\n      :before-upload=\"beforeUpload\"\r\n      :on-progress=\"handleProgress\"\r\n      :on-success=\"handleSuccess\"\r\n      :on-error=\"handleError\"\r\n      :headers=\"{ token: storage.getItem('token'), source: 1 }\"\r\n    >\r\n      <el-button type=\"primary\">选择文件</el-button>\r\n    </el-upload>\r\n  </div>\r\n</template>\r\n\r\n<script lang=\"ts\" setup>\r\nimport { reactive, ref } from \"vue\";\r\nimport { useFormItem, useFormDisabled } from \"element-plus\";\r\nimport type { UploadProps } from \"element-plus\";\r\nimport { showMessage, storage, toCssVal } from \"@/components/_utils\";\r\nimport config from \"@/config\";\r\nimport { StrNum, CommonObj, FinallyNext } from \"@/vite-env\";\nimport { defineOptions } from 'vue'; \ndefineOptions({ name: \"UploadFile\" }); \n\r\nexport interface FileAttrs {\r\n  url: string;\r\n  name: string;\r\n}\r\nconst props = withDefaults(\r\n  defineProps<{\r\n    modelValue?: FileAttrs;\r\n    size?: string | number;\r\n    showFileList?: boolean;\r\n    drag?: boolean;\r\n    accept?: string; //image/png, image/jpeg\r\n    limitSize?: number; //文件大小限制\r\n    action?: string;\r\n    showTips?: boolean;\r\n    handleSuccessRes?: (res: any) => string;\r\n  }>(),\r\n  Object.assign(\r\n    {\r\n      modelValue: () => reactive({ name: \"\", url: \"\" }),\r\n      size: 80,\r\n      showFileList: false,\r\n      // accept: \"image/png,image/jpg,image/jpeg\",\r\n      limitSize: 1024 * 1024 * 10, //10M\r\n      action: \"/proxy/common/uploadImage\",\r\n      showTips: true,\r\n      handleSuccessRes: (data: any) => {\r\n        return data.path;\r\n      },\r\n    },\r\n    config?.BaseCrud\r\n  )\r\n);\r\nconst emits = defineEmits([\"update:modelValue\", \"change\"]);\r\nconst { formItem } = useFormItem();\r\nconst { value: disabled } = useFormDisabled();\r\nconst newSize = toCssVal(props.size);\r\nconst file = ref<FileAttrs>(props.modelValue || { url: \"\", name: \"\" });\r\n// const tempSrc =\r\n//   \"https://files.xiangqinjiaoapp.com/user-file/D85QoX/20230903/face/tmp_dbf84a5a546905a1b554a5dc892cba8c.png\";\r\n// const file = computed<FileAttrs>({\r\n//   get() {\r\n//     return props.modelValue;\r\n//   },\r\n//   set(val: FileAttrs) {\r\n//     console.log(val, \"val---------------------1122\");\r\n//     emits(\"update:modelValue\", val);\r\n//     formItem?.validate(\"blur\");\r\n//   },\r\n// });\r\nconst tips = computed(() => {\r\n  const { accept, limitSize } = props;\r\n  const type = getAcceptTypeStr(accept);\r\n  const size = getLimitSizeStr(limitSize);\r\n  return `仅支持${type}，不超过${size}`;\r\n});\r\n// setTimeout(() => {\r\n//   file.value = tempSrc;\r\n//   // emits(\"update:modelValue\", tempSrc);\r\n//   // formItem?.validate(\"blur\");\r\n// }, 500);\r\n//上传前处理\r\nconst beforeUpload: UploadProps[\"beforeUpload\"] = file => {\r\n  const { limitSize, accept } = props;\r\n  const { type, size } = file;\r\n  const errTips = validType(accept, type) || validSize(limitSize, size);\r\n  if (errTips) {\r\n    showMessage(errTips, \"error\");\r\n    return false;\r\n  }\r\n  return true;\r\n};\r\nconst handleProgress: UploadProps[\"onProgress\"] = file => {\r\n  console.log(file, \"onProgress--------------------\");\r\n};\r\n// const handleSuccess: UploadProps[\"onSuccess\"] = (response, uploadFile) => {\r\n//   file.value = URL.createObjectURL(uploadFile.raw!);\r\n//   emits(\"change\", file.value);\r\n// };\r\nconst handleSuccess: UploadProps[\"onSuccess\"] = (res, uploadFile) => {\r\n  const { code, message, data } = res;\r\n  if (code === 1000) {\r\n    const url = props.handleSuccessRes(data);\r\n    const lastInd = uploadFile.name.lastIndexOf(\".\");\r\n    const name = uploadFile.name.slice(0, lastInd);\r\n    const obj: FileAttrs = { url, name };\r\n    file.value = { url, name };\r\n    console.log(obj);\r\n    emits(\"update:modelValue\", obj);\r\n    formItem?.validate(\"blur\");\r\n    emits(\"change\", file);\r\n  } else {\r\n    showMessage(message, \"error\");\r\n  }\r\n};\r\nconst handleError: UploadProps[\"onError\"] = (err: any) => {\r\n  // console.error(err);\r\n  // showMessage(\"文件上传失败\",'error');\r\n};\r\nfunction handleDelete() {\r\n  // file.value = \"\";\r\n}\r\n/**\r\n * 获取支持上传的文件后缀类型\r\n */\r\nfunction getAcceptTypeStr(accept: string): string {\r\n  const types = accept.split(\",\").map((it: string) => it.split(\"/\")[1]);\r\n  return types.join(\"，\");\r\n}\r\n/**\r\n * 获取支持上传的文件大小限制(自带单位)\r\n */\r\nfunction getLimitSizeStr(limitSize: number): string {\r\n  let size = limitSize / 1024;\r\n  let sizeStr = \"\";\r\n  if (size < 1024) {\r\n    sizeStr = `${size.toFixed(1)}kb`;\r\n  } else {\r\n    size = size / 1024;\r\n    sizeStr = `${size.toFixed(1)}Mb`;\r\n  }\r\n  return sizeStr;\r\n}\r\n/**\r\n * 校验文件类型\r\n * @param accept string  image/png,image/jpeg\r\n * @param fileType string  image/png,image/jpeg\r\n */\r\nfunction validType(accept: string | undefined, fileType: string): string {\r\n  let tips = \"\";\r\n  if (!accept) return tips;\r\n  const acceptTypes = accept.split(\",\");\r\n  if (!acceptTypes.includes(fileType)) {\r\n    tips = `仅支持上传${getAcceptTypeStr(accept)}格式的文件`;\r\n  }\r\n  return tips;\r\n}\r\n/**\r\n * 校验文件类型\r\n * @param accept string  image/png,image/jpeg\r\n * @param type string  image/png,image/jpeg\r\n */\r\nfunction validSize(limitSize: number, fileSize: number) {\r\n  return fileSize > limitSize ? `文件大小不能超过${getLimitSizeStr(limitSize)}` : \"\";\r\n}\r\n</script>\r\n\r\n<style lang=\"scss\" scoped>\r\n.upload-file {\r\n  width: 100%;\r\n}\r\n.upload {\r\n  margin-left: $gap-half;\r\n}\r\n// .upload {\r\n//   position: relative;\r\n//   height: v-bind(newSize);\r\n//   width: v-bind(newSize);\r\n//   border-radius: $radius-main;\r\n//   border: 1px dashed $color-border-main;\r\n//   background: $color-bg-lighter;\r\n//   transition: all $transition-time-main;\r\n//   .icon-close {\r\n//     position: absolute;\r\n//     right: -8px;\r\n//     top: -8px;\r\n//     z-index: 1000;\r\n//     opacity: 0.7;\r\n//     &:hover {\r\n//       opacity: 1;\r\n//     }\r\n//   }\r\n//   .img {\r\n//     height: 100%;\r\n//     width: 100%;\r\n//   }\r\n//   .icon {\r\n//     color: $color-text-light;\r\n//   }\r\n//   &:hover {\r\n//     border: 1px dashed $color-primary;\r\n//     .icon {\r\n//       color: $color-primary;\r\n//     }\r\n//   }\r\n//   &.disabled {\r\n//     border: 1px dashed $color-border-main;\r\n//     &:hover {\r\n//       cursor: not-allowed;\r\n//       .icon {\r\n//         cursor: not-allowed;\r\n//         color: $color-text-light;\r\n//       }\r\n//     }\r\n//   }\r\n// }\r\n// .tips {\r\n//   padding: $gap-qtr 0 0;\r\n//   line-height: 1.4;\r\n//   color: $color-text-light;\r\n//   font-size: $font-size-lighter;\r\n// }\r\n</style>\r\n"],"names":["props","__props","emits","__emit","formItem","useFormItem","value","disabled","useFormDisabled","toCssVal","size","file","ref","modelValue","url","name","computed","accept","limitSize","getAcceptTypeStr","getLimitSizeStr","beforeUpload","type","errTips","fileType","tips","acceptTypes","split","includes","tips2","validType","fileSize","validSize","showMessage","handleProgress","handleSuccess","res","uploadFile","code","message","data","handleSuccessRes","lastInd","lastIndexOf","slice","obj","validate","handleError","err","map","it","join","sizeStr","toFixed"],"mappings":"k8DAuCA,MAAMA,EAAQC,EA4BRC,EAAQC,GACRC,SAAEA,GAAaC,KACbC,MAAOC,GAAaC,IACZC,EAAST,EAAMU,MACzB,MAAAC,EAAOC,EAAeZ,EAAMa,YAAc,CAAEC,IAAK,GAAIC,KAAM,KAapDC,UAAS,KACd,MAAAC,OAAEA,EAAQC,UAAAA,GAAclB,EAGvB,MAAA,MAFMmB,EAAiBF,SACjBG,EAAgBF,IACD,IAQxB,MAAAG,EAA4CV,IAC1C,MAAAO,UAAEA,EAAWD,OAAAA,GAAWjB,GACxBsB,KAAEA,EAAMZ,KAAAA,GAASC,EACjBY,EA+DC,SAAUN,EAA4BO,GAC7C,IAAIC,EAAO,GACX,IAAKR,EAAeQ,OAAAA,EACd,MAAAC,EAAcT,EAAOU,MAAM,KAC5BD,EAAYE,SAASJ,KACjBK,EAAA,QAAQV,EAAiBF,WAE3BQ,OAAAA,CACT,CAvEkBK,CAAUb,EAAQK,IA6E3B,SAAUJ,EAAmBa,GACpC,OAAOA,EAAWb,EAAY,WAAWE,EAAgBF,KAAe,EAC1E,CA/E6Cc,CAAUd,EAAWR,GAChE,OAAIa,IACFU,EAAYV,EAAS,UACd,EAEF,EAEHW,EAA4CvB,IACE,EAM9CwB,EAA0C,CAACC,EAAKC,KACpD,MAAMC,KAAEA,EAAAC,QAAMA,EAASC,KAAAA,GAASJ,EAChC,GAAa,MAATE,EAAe,CACX,MAAAxB,EAAMd,EAAMyC,iBAAiBD,GAC7BE,EAAUL,EAAWtB,KAAK4B,YAAY,KACtC5B,EAAOsB,EAAWtB,KAAK6B,MAAM,EAAGF,GAChCG,EAAiB,CAAE/B,MAAKC,QACzBJ,EAAAL,MAAQ,CAAEQ,MAAKC,QAEpBb,EAAM,oBAAqB2C,GAC3B,MAAAzC,GAAAA,EAAU0C,SAAS,QACnB5C,EAAM,SAAUS,EAAI,MAEpBsB,EAAYM,EAAS,QACvB,EAEIQ,EAAuCC,IAAD,EAU5C,SAAS7B,EAAiBF,GAEjB,OADOA,EAAOU,MAAM,KAAKsB,KAAKC,GAAeA,EAAGvB,MAAM,KAAK,KACrDwB,KAAK,IACpB,CAIA,SAAS/B,EAAgBF,GACvB,IAAIR,EAAOQ,EAAY,KACnBkC,EAAU,GAOP,OANH1C,EAAO,KACT0C,EAAU,GAAG1C,EAAK2C,QAAQ,QAE1B3C,GAAc,KACd0C,EAAU,GAAG1C,EAAK2C,QAAQ,QAErBD,CACT"}